# ***Manually*** install nextcloud server on Ubuntu 22.04 
---

## Useful references - Courtesy credits and Gratitude
1. [How to Install LAMP Stack on Ubuntu 20.04 Server/Desktop](https://www.linuxbabe.com/ubuntu/install-lamp-stack-ubuntu-20-04-server-desktop)
2. [Install NextCloud on Ubuntu 20.04 with Apache (LAMP Stack)](https://www.linuxbabe.com/ubuntu/install-nextcloud-ubuntu-20-04-apache-lamp-stack)
3. [How to install Nextcloud 20 on Ubuntu Server 20.04](https://www.techrepublic.com/article/how-to-install-nextcloud-20-on-ubuntu-server-20-04/)
4. [Installation on Linux — Nextcloud latest Administration Manual latest documentation](https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html)
5. [How To Install MariaDB 10.5 on Ubuntu 20.04 (Focal Fossa)](https://computingforgeeks.com/how-to-install-mariadb-on-ubuntu-focal-fossa/)
6. Apache on Ubuntu Linux For Beginners [Part 1](https://www.linux.com/audience/devops/apache-ubuntu-linux-beginners/) and [Part 2 (how to enable SSL on Apache)](https://www.linux.com/training-tutorials/apache-ubuntu-linux-beginners-part-2/)

  **Note:** - Though almost all references use Ubuntu 20.04, the procedure has worked **perfectly well on Ubuntu 22.04**, Lubuntu 20.04 and Raspbian buster as detailed in earlier versions of this write-up. 

---

## What's different about this installation?

1. Files are stored locally on a **separate and dedicated disk partition** on the machine where the nextcloud server is running
1. There are 2 different approaches described here
   1. A completely __intranet only__ installation that uses
      1. a **self-signed security certificate** from a pair of *snakeoil* encryption certificates that Apache installs by *default*
      1. **No DNS lookups**. However **mDNS lookups** from avahi.service are leveraged for clients within the intranet
   1. *Additional steps* that combines __Tailscale VPN__ to [expose the nextcloud server outside your LAN](#exposing-the-nextcloud-server-outside-the-lan-with-tailscale-vpn) that uses
      1. a **TLS certificate generated by Tailscale**
      1. a DNS name from Tailscale VPN with the __device name__ and __tailnet name__

This write up is based on the actual `history` of commands executed by following a blend of the above references. 192.168.254.56 is the example ip address.

---

## Why install manually?
[Why not install via snap?](https://github.com/ln-komandur/linux-utils/blob/master/why-not-snapd.md)

---

## Software and Versions used in this installation

### On Ubuntu 22.04.5 LTS 
1. Linux kernel 6.8.0-60-generic (64 bit) - ***the latest as of June 2025***
2. [nextcloud-31.0.6 server](https://nextcloud.com/changelog/) - ***the latest as of June 2025***
3. mariadb  Ver 15.1 Distrib 10.11.13-MariaDB, for debian-linux-gnu (x86_64) using  EditLine wrapper - ***mariadb 10.11 is LTS, maintained until Feb 2028***
4. OpenJDK version "19.0.2" 2023-01-17, JRE build 19.0.2+7-Ubuntu-0ubuntu322.04 - ***the latest as of March 2023, used in June 2025***
5. apache2 Server version: Apache/2.4.52 (Ubuntu), Server built: 2025-04-03T09:05:48 - ***from Ubuntu 22.04 defaults***
6. PHP 8.3.22 (cli) (built: Jun  9 2025 14:03:11) (NTS) - ***[php8.3 is recommended for Nextcloud 30 per the system requirements](https://docs.nextcloud.com/server/30/admin_manual/installation/system_requirements.html). php8.1 is available from Ubuntu 22.04 defaults and should be [upgraded to php8.3](upgrade%20to%20php8.3.md)*** 


---

## Install the LAMP stack

Refer [How to Install LAMP Stack on Ubuntu 20.04 Server/Desktop](https://www.linuxbabe.com/ubuntu/install-lamp-stack-ubuntu-20-04-server-desktop)

### Install Apache and do basic set-up

`sudo apt update && sudo apt-get update && sudo apt upgrade && sudo apt-get upgrade` # *update and upgrade apt repos*

**Run [1-install-and-setup-apache2.sh](1-install-and-setup-apache2.sh)**. It will prompt and authenticate for `sudo` privilege 

### Configure Apache to redirect to https, and to use alias wherever supported by avahi.service

Providing `ServerAlias computername.local` helps to use the server url as _https://computername.local/nextcloud_ from Linux laptops and iOS devices on the intranet if _avahi-daemon.service_ is running on the server. Since Android devices do not support mDNS (Refer [...local hostname doesn't work on Android phones](https://raspberrypi.stackexchange.com/questions/91154/raspberry-pis-local-hostname-doesnt-work-on-android-phones) ), the `ServerName` has to remain as the IP address to make it accessible from those devices.

**Run [2-configure-https-and-alias.sh](2-configure-https-and-alias.sh)**. It will prompt and authenticate for `sudo` privilege 

The script configures slightly different from [Install NextCloud on Ubuntu 20.04 with Apache (LAMP Stack)](https://www.linuxbabe.com/ubuntu/install-nextcloud-ubuntu-20-04-apache-lamp-stack) as this nextcloud installation **DOES NOT** choose to use a DNS look up. It is based on both [How to install Nextcloud 20 on Ubuntu Server 20.04](https://www.techrepublic.com/article/how-to-install-nextcloud-20-on-ubuntu-server-20-04/) and [Installation on Linux — Nextcloud latest Administration Manual latest documentation](https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html)

Refer [Configure to redirect to HTTPS site](https://help.nextcloud.com/t/configure-to-redirect-to-https-site/89135/4) , [Redirect SSLD](https://cwiki.apache.org/confluence/display/HTTPD/RedirectSSL) and [Hardening and Security Guidance](https://docs.nextcloud.com/server/latest/admin_manual/installation/harden_server.html) for details about ```<VirtualHost>``` items in the conf file created by the script. 

**Note:** 
1.  Despite these configurations, there may be some errors until the installation is _**fully complete**_.
2.  Even when the installation is complete Firefox may report an error as ***The page isn’t redirecting properly  Firefox has detected that the server is redirecting the request for this address in a way that will never complete. This problem can sometimes be caused by disabling or refusing to accept cookies*** . Clicking the **Try Again** button would solve the problem (redirect to https)


### Configure Uncomplicated Firewall (UFW)

**Run [3-configure-ufw.sh](3-configure-ufw.sh)**. It will prompt and authenticate for `sudo` privilege

---

## Install MariaDB

Refer [How To Install MariaDB 10.5 on Ubuntu 20.04 (Focal Fossa)](https://computingforgeeks.com/how-to-install-mariadb-on-ubuntu-focal-fossa/) or [How to Install LAMP Stack on Ubuntu 20.04 Server/Desktop](https://www.linuxbabe.com/ubuntu/install-lamp-stack-ubuntu-20-04-server-desktop) for screenshots

**Run [4-install-MariaDB.sh](4-install-MariaDB.sh)** to install and start mariadb for configuring it. It will prompt and authenticate for `sudo` privilege

### Configure Mariadb

`sudo mysql_secure_installation` # *Set up root password, remove anonymous users, disallow remote login, remove test database, reload privilege tables*

`sudo mariadb -u root` # *Just to test*

or 

`mysql -u root -p` # *Just to test. Will prompt for mariadb root password you just set-up. Type exit at `MariaDB [(none)]>` prompt*

### Create nextcloud user account (database, username and password) on mysql DB

Refer [Install NextCloud on Ubuntu 20.04 with Apache (LAMP Stack)](https://www.linuxbabe.com/ubuntu/install-nextcloud-ubuntu-20-04-apache-lamp-stack) for screenshots

`sudo mysql` # *To create nextcloud user account (database, its user and password) on mysql DB*

**Use *YOUR* custom values below**

```
MariaDB [(none)]> create database NameForNextCloudDatabase;
MariaDB [(none)]> create user YOURNextCloudUser@localhost identified by 'your-password';
MariaDB [(none)]> grant all privileges on NameForNextCloudDatabase.* to YOURNextCloudUser@localhost identified by 'your-password';
MariaDB [(none)]> flush privileges;
MariaDB [(none)]> exit;
```

---

## Prepare the dedicated partition to save nextcloud server's data (user) files 

1. Create a separate partition of desired size and format it as `ext4` using GParted / KDE Partition Manager 
2. Follow the steps in [Create common mount points for partitions shared by all users and include them in fstab](https://github.com/ln-komandur/linux-utils/blob/master/common-mountpoints.md)
3. `sudo chown www-data:www-data /media/all-users-nextcloud-data/ -R` # *Assign the ownership of the mount point for the nextcloud server's data partition* to the web-root
   1.  There is no need for other users need to share this partition with the web-root. Therefore, files and directories in this partition need not inherit the group id. So, ensure that the setgid bit is **not** set `ls -l /media/all-users-nextcloud-data/` # *list the permissions of the partition*
   1.  In any case, unset the setgid bit with `sudo chmod -R g-s /media/all-users-nextcloud-data/` # *[Unset the setgid bit](https://linuxconfig.org/how-to-use-special-permissions-the-setuid-setgid-and-sticky-bits)*

---

## Install and Enable PHP Modules

Refer Step 4: Install and Enable PHP Modules in [Install NextCloud on Ubuntu 20.04 with Apache (LAMP Stack)](https://www.linuxbabe.com/ubuntu/install-nextcloud-ubuntu-20-04-apache-lamp-stack)

For Nextcloud 30 or above, **Run [5-install-php8_3.sh](5-install-php8_3.sh)**. It will prompt and authenticate for `sudo` privilege. Or [upgrade to php8.3](upgrade%20to%20php8.3.md) as it is recommended per the [System requirements](https://docs.nextcloud.com/server/30/admin_manual/installation/system_requirements.html)

`sudo service apache2 restart` # *[Optional step]. Restart apache2 to use php modules*

Also try `sudo service apache2 reload` # *Reload apache instead of restarting as an alternative option*

### Configuring PHP8.x

Refer [Uploading big files > 512MB — Nextcloud latest Administration Manual](https://docs.nextcloud.com/server/stable/admin_manual/configuration_files/big_file_upload_configuration.html?highlight=big%20files#configuring-php) 

**Run [6-Configure-php-settings.sh](6-Configure-php-settings.sh)** (it will prompt and authenticate for `sudo` privilege) to 
1. Increase PHP Memory Limit to 512M in `/etc/php/8.x/fpm/php.ini` file and `/etc/php/8.x/apache2/php.ini` ***if it is 128M***
2. Increase Upload File Size Limit to 2G in `/etc/php/8.x/fpm/php.ini` file and `/etc/php/8.x/apache2/php.ini`  in 2 places each ***if it is 2M***
3. Disable output_buffering in `/etc/php/8.x/fpm/php.ini` file and `/etc/php/8.x/apache2/php.ini` ***if it is set to any values (i.e. enabled)***
4. Restart apache
5. Create a test file (`/var/www/html/info.php`) to review the server's PHP information  
6. Allow the user to review the server's PHP information in a browser through http://localhost/info.php. _Refer [How to Install LAMP Stack on Ubuntu 20.04 Server/Desktop](https://www.linuxbabe.com/ubuntu/install-lamp-stack-ubuntu-20-04-server-desktop)_
7. Delete the test file after waiting for the user to press the enter key
8. `sudo systemctl restart apache2` # *Reload (or restart if needed)*


Login as admin and [check PHP under Administration Settings](https://192.168.254.56/nextcloud/index.php/settings/admin/serverinfo) for the following

-   Version: 8.x.y
-   Memory limit: 512 MB
-   Upload max size: 2 GB 

---   

## Install nextcloud server - Part 1: terminal (command line) activities

The following is based on [Install NextCloud on Ubuntu 20.04 with Apache (LAMP Stack)](https://www.linuxbabe.com/ubuntu/install-nextcloud-ubuntu-20-04-apache-lamp-stack)

[Download the latest compatible version from nextcloud changelog](https://nextcloud.com/changelog/)

Use `sha256sum ./Downloads/nextcloud-*.zip` # *Verify the installable file with against the [respective checksum in the sha256 file](https://nextcloud.com/changelog/)* 

`sudo unzip ./Downloads/nextcloud-*.zip  -d /var/www/` # *Extract the installable*

`sudo chown www-data:www-data /var/www/nextcloud/ -R` # *Change owner and group from root to www-data*

`sudo systemctl reload apache2` # *Reload (or restart if needed) apache before completing the installation through the web browser*

---

## Install the nextcloud server - Part 2: Complete the installation in a Browser
...by accessing https://192.168.254.56/nextcloud/
1. Accept the "Potential Security Risk Ahead" from self signed security certificates that the browser warns about, and Continue
2. Create an admin user account (and the first user account) for the nextcloud server
3. Give the path to the data folder as `/media/all-users-nextcloud-data/` along with credentials for mariaDB, and also enter the new username and password for the nextcloud database. **Note:** The browser WILL show errors because of trusted domains as 
      1. apache is already configured to redirect `ServerName 192.168.254.56` to `ServerAlias computername.local` http to https
      2. config.php is created only in this step and does not have `192.168.254.56` and `computername.local` listed as trusted_domains yet
3. **Fix:** Open the config.php file with `sudo nano /var/www/nextcloud/config/config.php` and edit the following to have both the IP address `192.168.254.56` and alias `computername.local`
      1. trusted domains
         ```
         'trusted_domains' =>
            array (
               0 => 'computername.local','192.168.254.56',
         ),
         ```
      2. the overwrite.cli.url 
         ```
         'overwrite.cli.url' =>  'https://computername.local/nextcloud','https://192.168.254.56/nextcloud',
         ```
      3. Include the line just below the above
         ```
         'overwriteprotocol' => 'https',
         ``` 
         The above helps to use the server url as `https://computername.local/nextcloud` from Linux laptops and iOS devices on the intranet if `avahi-daemon.service` is running on the server. Since Android devices do support mDNS (Refer [...local hostname doesn't work on Android phones](https://Gaveerrypi.stackexchange.com/questions/91154/raspberry-pis-local-hostname-doesnt-work-on-android-phones) ), the URL based on the IP address must also be given to use on those devices.
4. Restart apache `sudo systemctl restart apache2`         

### The nextcloud installation is now complete

### Post installation upgrades

Log in to the nextcloud server with admin user previlleges and upgrade to nextcloud from "Settings -> Administration -> Overview" if prompted

---

## Appendix

### Exposing the nextcloud server outside the LAN with Tailscale VPN

---

1. Create a tailscale account and add devices to it
1. Take a fun name for the `<tailnet_name>`
1. Connect the device that hosts the nextcloud server to tailnet and change its name from `computername` to `<NC_server_name>` to avoid exposing the real name
1. Generate a TLS certificate for the device using the following command. Refer [here on ideas to renew the TLS certificate](https://codingrelic.geekhold.com/2024/11/tailscale-certificates-with-nextcloud.html?m=1) . **Use the same command to renew it as well**

`sudo tailscale cert --cert-file=/etc/ssl/certs/tls-cert-<NextCloudServerTailscaleName_TailnetName_ts_net>.ts.net.pem --key-file=/etc/ssl/private/tls-cert-<NextCloudServerTailscaleName_TailnetName_ts_net>.ts.net.key <NextCloudServerTailscaleName>.<TailnetName>.ts.net` # *Reference https://tailscale.com/kb/1080/cli*

#### Alternatively create a systemd service which would automatically take care of renewing it too

```
sudo tee /lib/systemd/system/ask_tailscale_to_renew_TLS_certs.service <<EOF
[Unit]
Description=Ask tailscale to renew TLS certificates whenever the computer is started / re-started. Tailscale renews it if due per their policies. Reference https://tailscale.com/kb/1080/cli
Requires=tailscaled.service
After=tailscaled.service

[Service]
Type=oneshot
User=root
Group=root
ExecStartPre=/bin/bash -c 'echo $(date)'
ExecStart=/usr/bin/tailscale cert --cert-file=/etc/ssl/certs/tls-cert-<NextCloudServerTailscaleName_TailnetName_ts_net>.ts.net.pem --key-file=/etc/ssl/private/tls-cert-<NextCloudServerTailscaleName_TailnetName_ts_net>.ts.net.key <NextCloudServerTailscaleName>.<TailnetName>.ts.net
StandardOutput=append:/var/log/tailscale_TLS_cert_renewal_service.log
StandardError=append:/var/log/tailscale_TLS_cert_renewal_service.error

[Install]
WantedBy=multi-user.target
EOF
```

`sudo systemctl daemon-reload` # *Reload the systemctl daemon to read the new file, and each time after making any changes to the .service file*

`sudo systemctl restart ask_tailscale_to_renew_TLS_certs.service` # *Restart (Start if not already running) the ask_tailscale_to_renew_TLS_certs systemd service*

`sudo systemctl status ask_tailscale_to_renew_TLS_certs.service` # *Verify that the ask_tailscale_to_renew_TLS_certs systemd service is up and running*

#### Edit nextcloud.conf and incorporate the DNS entries and TLS certificates in it as below

```
<VirtualHost *:80>
    ServerName <NextCloudServerTailscaleName>.<TailnetName>.ts.net
    ServerAlias computername.local local_ip_address(e.g.192.168.254.56)
    # Redirects any request to http://<NextCloudServerTailscaleName>.<TailnetName>.ts.net/nextcloud or http://computername.local/nextcloud to https
    Redirect permanent /nextcloud https://computername.local/nextcloud
</VirtualHost>
<VirtualHost *:443>
    ServerName <NextCloudServerTailscaleName>.<TailnetName>.ts.net
    ServerAlias computername.local local_ip_address(e.g.192.168.254.56)
    Alias /nextcloud "/var/www/nextcloud/"
    ErrorLog ${APACHE_LOG_DIR}/nextcloud.error
    CustomLog ${APACHE_LOG_DIR}/nextcloud.access combined
        SSLEngine on
        SSLCertificateFile /etc/ssl/certs/tls-cert-<NextCloudServerTailscaleName_TailnetName_ts_net>.ts.net.pem
        SSLCertificateKeyFile /etc/ssl/private/tls-cert-<NextCloudServerTailscaleName_TailnetName_ts_net>.ts.net.key
```

#### Edit config.php for trusted domains as below

```
  'trusted_domains' => 
  array (
    0 => 'computername.local',
    1 => 'local_ip_address(e.g.192.168.254.56)',
    2 => '<NextCloudServerTailscaleName>.<TailnetName>.ts.net',
  ),


  'overwrite.cli.url' => 'https://computername.local/nextcloud',
  0 => 'https://local_ip_address(e.g.192.168.254.56)/nextcloud',
  1 => 'https://<NextCloudServerTailscaleName>.<TailnetName>.ts.net/nextcloud',

```

#### Reverse proxy

No tailscale reverse proxy is necessary

#### iOS NextCloud Client App permissions

Ensure that the iOS NextCloud Client App has permissions to use the cellular data

---

### Unable to access nextcloud server after its IP address changed

---

The nextcloud server's IP address could change for several reasons including, but not limited to the following
1. if it is not static or bound to the mac address,  
2. connecting it to a different network, a new router, 
3. change in DHCP range of the existing router
4. connecting the nextcloud server to the same network / router through a different network card (e.g. Wired / Wireless, new network card) 
5. SSD / HDD on which nextcloud is installed is moved to a different PC
6. etc. 

Imagine the nextcloud server's IP address changed from `192.168.254.56` to `192.168.0.27`. After this change, when nextcloud is accessed using the old IP address in the browser (i.e. https://192.168.254.56/nextcloud), an "Access through untrusted domain" page is most likely to be displayed.

Do the following to put the nextcloud server back on track.

1. Log onto the nextcloud server box (Physically / Virtually e.t.c)
2. Open the config.php file with `sudo nano /var/www/nextcloud/config/config.php` and edit the following with the new IP address
      1. the trusted domains from
         ```
         'trusted_domains' =>
            array (
               0 => 'computername.local','192.168.254.56',
         ),
         ```
         to
      
         ```   
         'trusted_domains' =>
            array (
               0 => 'computername.local','192.168.0.27',
         ),
         ```
      2. the overwrite.cli.url from
         ```
         'overwrite.cli.url' =>  'https://computername.local/nextcloud','https://192.168.254.56/nextcloud',
         ```
         to
         ```
         'overwrite.cli.url' => 'https://computername.local/nextcloud','https://192.168.0.27/nextcloud',
         ```         
3. Edit the new IP address in `/etc/apache2/sites-available/nextcloud.conf` after the `ServerName` fields
4. Restart apache server with `sudo systemctl restart apache2` and also reload it with `sudo systemctl reload apache2`
5. It's quite possible that the problem is still not resolved, and even the "Access through untrusted domain" page does not show up when accessing `https://192.168.0.27/nextcloud` through the browser.
6. In that case, try to access `https://192.168.0.27` and see if the apache default welcome page is shown with the configuration overview. If not, the problem is very likely that the server's `ufw` rules need to be updated.
7. Add new UFW rules as below and repeat the step 5 (first) and 4 (after 5) above. 
      1. `sudo ufw allow from 192.168.0.0/24 to any port 22 proto tcp`
      2. `sudo ufw allow from 192.168.0.0/24 to any port 80 proto tcp`
      3. `sudo ufw allow from 192.168.0.0/24 to any port 443 proto tcp`
      4. `sudo ufw allow in from 192.168.0.1 to 224.0.0.0/24`
8. Remove the old `ufw` rules as appropriate after executing `sudo ufw status numbered` and deleting numbered rules with `sudo ufw delete #` (replace # with the rule number)

### Manually stop and start nextcloud server

Use this method to avoid autostarts on older hardware to speed up boot-up

1. `sudo systemctl disable phpsessionclean.timer php7.4-fpm.service mariadb.service apache2.service` # *Disable these 4 services so that they can be manually stopped and started by scripts*
2. In `/etc/fstab` make sure to have **`noauto`** in the line `UID=<UUID of the partition><tab>/media/all-users-nextcloud-data<tab>ext4<tab>noauto,nosuid,nodev,noexec,nouser,nofail<tab>0<tab>0` for it to be mounted manually. Also make sure the line ends with "0" (i.e. fsck will not be run on this partition at boot
3. Download [start-nextcloud.sh](start-nextcloud.sh) (which also tries to renew the Tailscale TLS certificate everytime) and [stop-nextcloud.sh](stop-nextcloud.sh) to super user's home directory. 
4. `chmod +x <script-name.sh>` # *Give execute permissions to both scrips*
5. `sudo [start-nextcloud.sh](start-nextcloud.sh)` # *Start the server manually* and `sudo [stop-nextcloud.sh](stop-nextcloud.sh)` # *Stop the server manually* as needed

### Automatically start nextcloud server

Use this method to avoid the need for any user to login

1.  `sudo systemctl enable ufw.service apache2.service mariadb.service php8.3-fpm.service phpsessionclean.timer` # *Enable services to start automatically*
2.  In `/etc/fstab` make sure to have **`auto`** in the line `UID=<UUID of the partition><tab>/media/all-users-nextcloud-data<tab>ext4<tab>auto,nosuid,nodev,noexec,nouser,nofail<tab>0<tab>0` so that it is mounted automatically. Also make sure the line ends with "0" (i.e. fsck will not be run on this partition at boot
3.  [Use a service to automatically try and renew the Tailscale TLS certificate on boot](#alternatively-create-a-systemd-service-which-would-automatically-take-care-of-renewing-it-too)


### Add missing indices manually while the instance continues to run

`cd /var/www/nextcloud`

`sudo -u www-data php occ db:add-missing-indices` # *Add missing indices manually while the instance continues to run*

### Delete older versions of all files for all users while the instance continues to run

`cd /var/www/nextcloud`

`sudo -u www-data php occ versions:cleanup` # *Delete older versions of all files for all users while the instance continues to run*

### Add user via occ command

`cd /var/www/nextcloud`

`sudo -E -u www-data php occ user:add --display-name="FNU LNU" --group="group-A" --group="group-B" username` # *Create a user and assign them group-A and group-B.* 
This will prompt for password, but not email. However, upon first login, this approach will still ask for the password to be reset through the link it has sent to the non-existent email. Ignore the message and login again.

Refer [the nextcloud admin manual](https://docs.nextcloud.com/server/latest/admin_manual/occ_command.html) for more occ commands


